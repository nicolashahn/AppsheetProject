<html>
	<head>
		<style>
			body{
				background-color:rgb(20,20,20);
			}
			.imagediv{
				width:800px;
				margin:auto;
				padding:40px;
				background-color:black;
				visibility:hidden;
			}
			#loading{
				padding:40px;
				color:white;
				text-align:center;
			}
		</style>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/photoset-grid/1.0.1/jquery.photoset-grid.min.js"></script>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
	</head>
	<body>
		<script>

		/////////////
		// globals //
		/////////////

		var url = 'https://appsheettest1.azurewebsites.net/sample/posts';

		//////////////////////
		// helper functions //
		//////////////////////

		// for putting similar-dimension images next to each other
		// makes the grid more uniform
		function sortByImageRatio(imgs){
			imgs.sort(function(a,b){
				// last 7 chars of the url are <width>/<height>
				// <http...blah/400/300> means width 400, height 300
				heightA = parseInt(a.picture.substr(a.picture.length-3));
				widthA = parseInt(a.picture.substr(a.picture.length-7, a.picture.length-4));
				heightB = parseInt(b.picture.substr(b.picture.length-3));
				widthB = parseInt(b.picture.substr(b.picture.length-7, b.picture.length-4));
				return (heightA/widthA) - (heightB/widthB);
			});
			// getJSON returns multiple of the same picture, get grouped next to each other
			// so mix them up a bit so they don't end up next to each other as often
			for (var i = 0; i < imgs.length-3; i+=2){
				var tmp = imgs[i];
				imgs[i] = imgs[i+3];
				imgs[i+3] = tmp;
			}
		}

		// create img tag for each JSON object
		function createImageTags(imgs){
			for (var i = 0; i < imgs.length; i++){
				var img = $('<img />',{
					id: imgs[i].id,
					class: 'images',
					src: imgs[i].picture,
					alt: imgs[i].text,
				});
				img.appendTo($('.imagediv'));
			}
			console.log(imgs[0]);
		}

		// creates the string that denotes how many images to put in each row
		function generateLayoutString(numImgs){
			var i = 0;
			layoutStr = ''
			while (i < numImgs){
				i += 6;
				layoutStr = layoutStr + '123';
			}
			return layoutStr;
		}

		// on desktop, make sure grid doesn't stretch pics too much
		// mobile, have it fill the window
		function responsiveWidth(){
			var width = $(window).width();
			if (width > 750){
				return 600;
			} else {
				return '80%';
			}
		}

		// arrange in grid using photoset-grid library
		function arrangeGrid(imgs){
			$('.imagediv').photosetGrid({
				// ensure an even grid in case # of images returned ever changes
				layout: generateLayoutString(imgs.length),
				width: responsiveWidth(),
				gutter: '5px',
				borderActive: true,
				borderWidth: '2px',
				borderRadius: '2px',
				onInit: function(){},
				onComplete: function(){
					// $('.imagediv').fadeIn();
						$('#loading').hide()
						$('.imagediv').css({
							'visibility':'visible'
						});
					console.log("finished loading images");
				}
			});	
		}

		////////////////////
		// main execution //
		////////////////////

		$.when(
			$.getJSON(url)
		).done( function(imgs){
			main(imgs);
		});

		function main(imgs){
			sortByImageRatio(imgs);
			createImageTags(imgs);
			arrangeGrid(imgs);
		}

		// ensure responsiveness on window resize
		$(window).resize(function(){
			var width = $(window).width();
			if (width > 750){
				$('.imagediv').css('width', 600);
			} else {
				$('.imagediv').css('width', width*.8);
			}
		});

		

		</script>
		<h1 id="loading">Loading images...</h1>
		<div class="imagediv"></div>
	</body>
</html>